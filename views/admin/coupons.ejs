<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Evara Dashboard</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="" />
  <meta property="og:type" content="" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="" />
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg" />
  <!-- Template CSS -->
  <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="index.html" class="brand-wrap">
        <h2>PICK UR PCEE</h2>
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin/dashboard">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item  ">
          <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/orderList"> <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/categories"> <i class="icon material-icons md-store"></i>
            <span class="text">Categories</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/products/add"> <i class="icon material-icons md-add_box"></i>
            <span class="text">Add product</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/salesReport">
            <i class="icon material-icons md-monetization_on"></i>
            <span class="text">Sales Report</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/userList"> <i class="icon material-icons md-person"></i>
            <span class="text">User</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/offers"> <i class="icon material-icons md-comment"></i>
            <span class="text">Offers</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/brands">
            <i class="icon material-icons md-stars"></i>
            <span class="text">Brands</span>
          </a>
        </li>
        <li class="menu-item active">
          <a class="menu-link" disabled href="/admin/coupons">
            <i class="icon material-icons md-pie_chart"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search">
      </div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside">
          <i class="material-icons md-apps"></i>
        </button>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link btn-icon darkmode" href="#">
              <i class="material-icons md-nights_stay"></i>
            </a>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-item text-danger" href="/admin/logout"><i
                class="material-icons md-exit_to_app"></i>Logout</a>

          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="container mt-5">
        <h2>Coupon Management</h2>

        <!-- Add Coupon Button -->
        <!-- Modal Trigger Button -->
        <!-- Coupon Modal Trigger Button -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal">
          Add Coupon
        </button>

        <!-- Coupon Modal -->
        <div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addCouponModalLabel">Add New Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="couponForm">
                  <!-- Coupon Code -->
                  <div class="mb-3">
                    <label for="couponCode" class="form-label">Coupon Code</label>
                    <input type="text" class="form-control" id="couponCode" name="couponCode"
                      placeholder="Enter coupon code">
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Coupon Type (Percentage or Fixed) -->
                  <div class="mb-3">
                    <label for="couponType" class="form-label">Discount Type</label>
                    <select class="form-select" id="discountType" name="discountType">
                      <option value="" selected disabled>Select type</option>
                      <option value="percentage">Percentage</option>
                      <option value="fixed">Fixed Amount</option>
                    </select>
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Discount Value -->
                  <div class="mb-3">
                    <label for="discountValue" class="form-label">Discount Value</label>
                    <input type="number" class="form-control" id="discountValue" name="discountValue"
                      placeholder="Enter discount value">
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Minimum Spend -->
                  <div class="mb-3">
                    <label for="minSpend" class="form-label">Minimum Discount</label>
                    <input type="number" class="form-control" id="minSpend" name="minSpend"
                      placeholder="Enter minimum spend amount">
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Maximum Discount (if percentage) -->
                  <div class="mb-3">
                    <label for="maxDiscount" class="form-label">Maximum Discount</label>
                    <input type="number" class="form-control" id="maxDiscount" name="maxDiscount"
                      placeholder="Enter maximum discount value">
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Expiry Date -->
                  <div class="mb-3">
                    <label for="expiryDate" class="form-label">Expiry Date</label>
                    <input type="date" class="form-control" id="expiryDate" name="expiryDate">
                    <span class="error" style="color: red;"></span>
                  </div>

                  <!-- Usage Limit -->
                  <div class="mb-3">
                    <label for="usageLimit" class="form-label">Usage Limit</label>
                    <input type="number" class="form-control" id="usageLimit" name="usageLimit"
                      placeholder="Enter usage limit">
                    <span class="error" style="color: red;"></span>
                  </div>


                  <!-- Footer Buttons -->
                  <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Coupon</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editCouponModalLabel">Edit Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editCouponForm">
                  <input type="hidden" id="editCouponId">

                  <div class="mb-3">
                    <label class="form-label">Coupon Code</label>
                    <input type="text" class="form-control" id="editCouponCode">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Discount Type</label>
                    <select class="form-select" id="editDiscountType">
                      <option value="" disabled>Select type</option>
                      <option value="percentage">Percentage</option>
                      <option value="fixed">Fixed Amount</option>
                    </select>
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Discount Value</label>
                    <input type="number" class="form-control" id="editDiscountValue">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Minimum Purchase</label>
                    <input type="number" class="form-control" id="editMinSpend">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Maximum Discount</label>
                    <input type="number" class="form-control" id="editMaxDiscount">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Expiry Date</label>
                    <input type="date" class="form-control" id="editExpiryDate">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Usage Limit</label>
                    <input type="number" class="form-control" id="editUsageLimit">
                    <span class="error" style="color:red;"></span>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Coupon</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>


        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Coupon Code</th>
              <th>Discount</th>
              <th>Expiry Date</th>
              <th>Min Purchase</th>
              <th>Max Purchase</th>
              <th>Usage Limit</th>
              <th>Used Count</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% coupons.forEach(coupon=> { %>
              <tr>
                <td>
                  <%= coupon.code %>
                </td>
                <td>
                  <%= coupon.discountType==='percentage' ? coupon.discountValue + '%' : '₹' + coupon.discountValue %>
                </td>
                <td>
                  <%= new Date(coupon.expiryDate).toDateString() %>
                </td>
                <td>₹<%= coupon.minPurchaseValue %>
                </td>
                <td>₹<%= coupon.maxPurchaseValue %>
                </td>
                <td>
                  <%= coupon.usageLimit %>
                </td>
                <td>
                  <%= coupon.usedCount %>
                </td>
                <td>
                  <%= coupon.isActive ? 'Active' : 'Inactive' %>
                </td>
                <td>
                  <button class="btn btn-warning btn-sm editBtn" data-id="<%= coupon._id %>"
                    data-code="<%= coupon.code %>" data-type="<%= coupon.discountType %>"
                    data-value="<%= coupon.discountValue %>" data-min="<%= coupon.minPurchaseValue %>"
                    data-max="<%= coupon.maxPurchaseValue %>"
                    data-expiry="<%= coupon.expiryDate.toISOString().slice(0,10) %>"
                    data-limit="<%= coupon.usageLimit %>">
                    Edit
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="deleteCoupon('<%= coupon._id %>')">Delete</button>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>

        <div class="pagination-area mt-30 mb-50">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-start">
              <% if (currentPage> 1) { %>
                <li class="page-item">
                  <a class="page-link" href="?page=<%= currentPage - 1 %>">&laquo;</a>
                </li>
                <% } %>

                  <% for (let i=1; i <=totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                      <a class="page-link" href="?page=<%= i %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>

                      <% if (currentPage < totalPages) { %>
                        <li class="page-item">
                          <a class="page-link" href="?page=<%= currentPage + 1 %>">&raquo;</a>
                        </li>
                        <% } %>
            </ul>
          </nav>
        </div>
      </div>
      <!-- card .// -->
    </section>
    <!-- content-main end// -->
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>
            document.write(new Date().getFullYear());
          </script>
          ©, Evara - HTML Ecommerce Template .
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>
  </main>
  <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/vendors/select2.min.js"></script>
  <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
  <!-- Main Script -->
  <script src="/assets/js/main.js" type="text/javascript"></script>
  <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
    integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>

    function deleteCoupon(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "No, cancel!",
        buttonsStyling: false,
        customClass: {
          confirmButton: "btn btn-danger",
          cancelButton: "btn btn-secondary",
        },
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/admin/coupons/${id}`,
            type: "DELETE",
            success: function (response) {
              if (response.success) {
                Swal.fire({
                  text: "Deleted successfully!",
                  icon: "success",
                  timer: 1000,
                  showConfirmButton: false,
                });
                location.reload()
              } else {
                Swal.fire({
                  text: "deleting failed",
                  icon: "error",
                  timer: 1000,
                  showConfirmButton: false,
                });
              }
            },
            error: function (xhr, status, error) {
              Swal.fire({
                text: "Error deleting item! Try again later.",
                icon: "error",
                confirmButtonText: "Ok",
                buttonsStyling: false,
                customClass: {
                  confirmButton: "btn btn-primary",
                },
              });
            },
          });
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          Swal.fire({
            text: "Your data is safe!",
            icon: "info",
            timer: 1000,
            showConfirmButton: false,
          });
        }
      });
    }

    const couponCode = document.getElementById('couponCode');
    const discountType = document.getElementById('discountType');
    const discountValue = document.getElementById('discountValue');
    const minSpend = document.getElementById('minSpend');
    const maxDiscount = document.getElementById('maxDiscount');
    const expiryDate = document.getElementById('expiryDate');
    const usageLimit = document.getElementById('usageLimit');
    const couponForm = document.getElementById('couponForm');


    let isValid = true;

    const setError = (input, message) => {
      const inputControl = input.parentElement;
      const errorDisplay = inputControl.querySelector(".error");
      errorDisplay.innerText = message;
      inputControl.classList.add("error");
      inputControl.classList.remove("success");
      isValid = false;
    };

    const setSuccess = (input) => {
      const inputControl = input.parentElement;
      const errorDisplay = inputControl.querySelector(".error");
      errorDisplay.innerText = "";
      inputControl.classList.add("success");
      inputControl.classList.remove("error");
    };

    const validateCouponInputs = () => {
      isValid = true;

      const couponCodeValue = couponCode.value.trim();
      const discountTypeValue = discountType.value;
      const discountValueValue = discountValue.value.trim();
      const minSpendValue = minSpend.value.trim();
      const maxDiscountValue = maxDiscount.value.trim();
      const expiryDateValue = expiryDate.value;
      const usageLimitValue = usageLimit.value.trim();


      if (couponCodeValue === "") {
        setError(couponCode, "Please enter a coupon code.");
      } else {
        setSuccess(couponCode);
      }


      if (discountTypeValue === "") {
        setError(discountType, "Please select a coupon type.");
      } else {
        setSuccess(discountType);
      }


      if (discountValueValue === "") {
        setError(discountValue, "Please enter a valid discount value greater than 0.");
      } else {
        setSuccess(discountValue);
      }


      if (minSpendValue === "") {
        setError(minSpend, "Please enter a valid minimum spend amount.");
      } else {
        setSuccess(minSpend);
      }


      if (maxDiscountValue === "") {
        setError(maxDiscount, "Please enter a valid maximum discount value.");
      } else {
        setSuccess(maxDiscount);
      }

      if (expiryDateValue === "") {
        setError(expiryDate, "Please select an expiry date.");
      } else {
        const today = new Date();
        const expiry = new Date(expiryDateValue);
        if (expiry <= today) {
          setError(expiryDate, "Expiry date must be in the future.");
        } else {
          setSuccess(expiryDate);
        }
      }


      if (usageLimitValue.trim() === "") {
        setError(usageLimit, "Please enter a valid usage limit.");
      } else {
        setSuccess(usageLimit);
      }

      return isValid;
    };


    couponForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const data = {
        couponCode: document.getElementById("couponCode").value,
        discountType: document.getElementById("discountType").value,
        discountValue: document.getElementById("discountValue").value,
        minSpend: document.getElementById("minSpend").value,
        maxDiscount: document.getElementById("maxDiscount").value,
        expiryDate: document.getElementById("expiryDate").value,
        usageLimit: document.getElementById("usageLimit").value,

      };
      if (validateCouponInputs()) {
        $.ajax({
          url: "/admin/coupons",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            if (response.success) {
              showToast("Coupon added successfully", "success");
              window.location.reload()
            } else {
              showToast(response.message, "error");
            }
          },
          error: function (error) {
            showToast("Error" + error, "error");
          }
        })
      }
    });

    function showToast(message, type) {
      let backgroundColor;

      if (type === "success") {
        backgroundColor = "green";
      } else if (type === "error") {
        backgroundColor = "red";
      } else {
        backgroundColor = "gray";
      }

      Toastify({
        text: message,
        duration: 2000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: backgroundColor,
      }).showToast();
    }


    $(document).on("click", ".editBtn", function () {
      const id = $(this).data("id");
      $("#editCouponId").val(id);
      $("#editCouponCode").val($(this).data("code"));
      $("#editDiscountType").val($(this).data("type"));
      $("#editDiscountValue").val($(this).data("value"));
      $("#editMinSpend").val($(this).data("min"));
      $("#editMaxDiscount").val($(this).data("max"));
      $("#editExpiryDate").val($(this).data("expiry"));
      $("#editUsageLimit").val($(this).data("limit"));

      $("#editCouponModal").modal("show");
    });

    // Handle edit form submit
    $("#editCouponForm").on("submit", function (e) {
      e.preventDefault();

      const id = $("#editCouponId").val();
      const data = {
        code: $("#editCouponCode").val(),
        discountType: $("#editDiscountType").val(),
        discountValue: $("#editDiscountValue").val(),
        minSpend: $("#editMinSpend").val(),
        maxDiscount: $("#editMaxDiscount").val(),
        expiryDate: $("#editExpiryDate").val(),
        usageLimit: $("#editUsageLimit").val(),
      };

      $.ajax({
        url: `/admin/coupons/${id}`,
        type: "PATCH",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (response) {
          if (response.success) {
            showToast("Coupon updated successfully", "success");
            $("#editCouponModal").modal("hide");
            location.reload();
          } else {
            showToast(response.message, "error");
          }
        },
        error: function () {
          showToast("Update failed. Try again later.", "error");
        }
      });
    });

  </script>
</body>

</html>