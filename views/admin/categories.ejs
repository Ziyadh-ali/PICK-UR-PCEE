<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Evara Dashboard</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="" />
  <meta property="og:type" content="" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="" />
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg" />
  <!-- Template CSS -->
  <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="index.html" class="brand-wrap">
        <h2>PICK UR PCEE</h2>
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin/dashboard">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item  ">
          <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/orderList"> <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
        <li class="menu-item active">
          <a class="menu-link" href="/admin/categories"> <i class="icon material-icons md-store"></i>
            <span class="text">Categories</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/products/add"> <i class="icon material-icons md-add_box"></i>
            <span class="text">Add product</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/salesReport">
            <i class="icon material-icons md-monetization_on"></i>
            <span class="text">Sales Report</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/userList"> <i class="icon material-icons md-person"></i>
            <span class="text">User</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/offers"> <i class="icon material-icons md-comment"></i>
            <span class="text">Offers</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/brands">
            <i class="icon material-icons md-stars"></i>
            <span class="text">Brands</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" disabled href="/admin/coupons">
            <i class="icon material-icons md-pie_chart"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search">
      </div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside">
          <i class="material-icons md-apps"></i>
        </button>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link btn-icon darkmode" href="#">
              <i class="material-icons md-nights_stay"></i>
            </a>
          </li>
          <li class="dropdown nav-item">
            <a class="dropdown-item text-danger" href="/admin/logout"><i
                class="material-icons md-exit_to_app"></i>Logout</a>

          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">

      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Categories</h2>
          <p>Add, edit or delete a category</p>
        </div>
        <button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#addCategoryModal">
          Add New Category
        </button>
      </div>

      <!-- Add Category Modal -->
      <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="addCategoryModalLabel">Add Category</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addCategoryForm" action="/admin/categories" method="post">
                <div class="mb-3">
                  <label class="col-form-label">Category Name:</label>
                  <input type="text" class="form-control" id="CategoryName" name="name" />
                  <span class="error" style="color: red"></span>
                </div>
                <div class="mb-3">
                  <label class="col-form-label">Description:</label>
                  <textarea class="form-control" id="description" name="description"></textarea>
                  <span class="error" style="color: red"></span>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Create Category</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      </div>
      <div>
        <!-- Button trigger modal -->

        <div class="card">
          <div class="card-body">
            <div class="row">
              <% if (right_message) { %>
                <div class="text-success text-center" style="color: green">
                  <%= right_message %>
                </div>
                <% } %>
                  <% if (err_message) { %>
                    <div class="text-danger text-center" style="color: red">
                      <%= err_message %>
                    </div>
                    <% } %>
                      <div class="col-md-12">
                        <div class="table-responsive">
                          <form method="GET" action="/admin/categories" class="d-flex mb-3">
                            <input type="text" name="search" value="<%= search %>" placeholder="Search Categories"
                              class="form-control bg-white" />

                            <select name="status" class="form-select">
                              <option value="all" <%=statusFilter==="all" ? "selected" : "" %>>All</option>
                              <option value="active" <%=statusFilter==="active" ? "selected" : "" %>>Active</option>
                              <option value="inactive" <%=statusFilter==="inactive" ? "selected" : "" %>>Inactive
                              </option>
                            </select>

                            <button type="submit" class="btn btn-primary">Filter</button>
                          </form>
                          <table class="table table-hover">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>List/Unlist</th>
                                <th>Edit</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% Categories.forEach((category, index)=> { %>
                                <tr>
                                  <td>
                                    <%= (currentPage - 1) * limit + index + 1 %>
                                  </td>
                                  <td><b>
                                      <%= category.name %>
                                    </b></td>
                                  <td>
                                    <%= category.description %>
                                  </td>

                                  <td>
                                    <% if (category.status) { %>
                                      <span class="badge rounded-pill alert-success status-badge"
                                        data-id="<%= category._id %>">Active</span>

                                      <% } else { %>
                                        <span class="badge rounded-pill alert-danger status-badge"
                                          data-id="<%= category._id %>">Not Active</span>

                                        <% } %>
                                  </td>

                                  <td>
                                    <% if (category.status) { %>
                                      <button type="button" class="btn btn-sm btn-danger unlist-btn"
                                        data-id="<%= category._id %>">Unlist</button>

                                      <% } else { %>
                                        <button type="button" class="btn btn-sm btn-success list-btn"
                                          data-id="<%= category._id %>">List</button>

                                        <% } %>
                                  </td>

                                  <td>
                                    <button type="button" class="btn btn-sm btn-brand editCategoryBtn"
                                      data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                                      data-id="<%= category._id %>" data-name="<%= category.name %>"
                                      data-description="<%= category.description %>">
                                      <i class="material-icons md-edit"></i> Edit
                                    </button>
                                  </td>
                                </tr>
                                <% }) %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      <!-- .col// -->
            </div>
            <!-- .row // -->
            <div class="pagination-area mt-30 mb-50">
              <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-start">

                  <!-- Previous -->
                  <% if (currentPage> 1) { %>
                    <li class="page-item">
                      <a class="page-link"
                        href="?page=<%= currentPage - 1 %>&search=<%= search %>&status=<%= statusFilter %>">
                        <i class="material-icons md-chevron_left"></i>
                      </a>
                    </li>
                    <% } %>

                      <!-- Pages -->
                      <% for (let i=1; i <=totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>" <%=currentPage===i
                          ? 'aria-current="page"' : '' %>>
                          <a class="page-link" href="?page=<%= i %>&search=<%= search %>&status=<%= statusFilter %>">
                            <%= i %>
                          </a>
                        </li>
                        <% } %>

                          <!-- Next -->
                          <% if (currentPage < totalPages) { %>
                            <li class="page-item">
                              <a class="page-link"
                                href="?page=<%= currentPage + 1 %>&search=<%= search %>&status=<%= statusFilter %>">
                                <i class="material-icons md-chevron_right"></i>
                              </a>
                            </li>
                            <% } %>

                </ul>
              </nav>
            </div>
          </div>
          <!-- card body .// -->
        </div>
        <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="editCategoryForm" method="POST">
                <div class="modal-header">
                  <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="editCategoryId" name="id" />

                  <div class="mb-3">
                    <label for="editCategoryName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="editCategoryName" name="name" required />
                    <div class="error text-danger small"></div>
                  </div>

                  <div class="mb-3">
                    <label for="editCategoryDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="editCategoryDescription" name="description" required></textarea>
                    <div class="error text-danger small"></div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- card .// -->
    </section>
    <!-- content-main end// -->
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>
            document.write(new Date().getFullYear());
          </script>
          Â©, Evara - HTML Ecommerce Template .
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>
  </main>
  <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/vendors/select2.min.js"></script>
  <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
  <!-- Main Script -->
  <script src="/assets/js/main.js" type="text/javascript"></script>
  <script>
    // Populate Edit Category Modal
    document.addEventListener("DOMContentLoaded", () => {
      const editCategoryModal = document.getElementById("editCategoryModal");
      const editForm = document.getElementById("editCategoryForm");
      const idInput = document.getElementById("editCategoryId");
      const nameInput = document.getElementById("editCategoryName");
      const descInput = document.getElementById("editCategoryDescription");

      document.querySelectorAll(".editCategoryBtn").forEach(button => {
        button.addEventListener("click", () => {
          const id = button.dataset.id;
          const name = button.dataset.name;
          const description = button.dataset.description;

          // Fill modal fields
          idInput.value = id;
          nameInput.value = name;
          descInput.value = description;

          // Update form action dynamically
          editForm.action = `/admin/categories/edit/${id}?_method=PATCH`;
        });
      });
    });
  </script>

  <script>
    // Validation helpers
    const setError = (input, message) => {
      const inputControl = input.parentElement;
      const errorDisplay = inputControl.querySelector(".error");
      errorDisplay.innerText = message;
      inputControl.classList.add("error");
      inputControl.classList.remove("success");
    };

    const setSuccess = (input) => {
      const inputControl = input.parentElement;
      const errorDisplay = inputControl.querySelector(".error");
      errorDisplay.innerText = "";
      inputControl.classList.add("success");
      inputControl.classList.remove("error");
    };

    const validateCategoryForm = (nameInput, descInput) => {
      let isValid = true;
      const nameValue = nameInput.value.trim();
      const descValue = descInput.value.trim();

      if (nameValue === "") {
        setError(nameInput, "Name is required");
        isValid = false;
      } else if (!/^[a-zA-Z0-9 _-]+$/.test(nameValue)) {
        setError(nameInput, "Only letters, numbers, spaces, underscores, and dashes allowed");
        isValid = false;
      } else {
        setSuccess(nameInput);
      }

      if (descValue === "") {
        setError(descInput, "Description is required");
        isValid = false;
      } else {
        setSuccess(descInput);
      }

      return isValid;
    };

    // Add Form Validation
    const addForm = document.getElementById("addCategoryForm");
    const addName = document.getElementById("CategoryName");
    const addDesc = document.getElementById("description");

    addForm.addEventListener("submit", (event) => {
      if (!validateCategoryForm(addName, addDesc)) {
        event.preventDefault();
      }
    });

    // Edit Form Validation
    const editForm = document.getElementById("editCategoryForm");
    const editName = document.getElementById("editCategoryName");
    const editDesc = document.getElementById("editCategoryDescription");

    editForm.addEventListener("submit", (event) => {
      if (!validateCategoryForm(editName, editDesc)) {
        event.preventDefault();
      }
    });
  </script>

  <script>
    $(document).ready(function () {

      attachListEvents();
      attachUnlistEvents();

      // UNLIST CATEGORY
      function attachUnlistEvents() {
        $(".unlist-btn").off("click").on("click", function () {
          const id = $(this).data("id");
          const btn = $(this);

          $.ajax({
            url: `/admin/categories/unlist/${id}`,
            method: "PATCH",
            contentType: "application/json",
            success: function (data) {
              if (data.success) {

                // Update badge
                const badge = $(`.status-badge[data-id="${id}"]`);
                badge.text("Not Active");
                badge.removeClass("alert-success").addClass("alert-danger");

                // Replace button
                btn.replaceWith(`<button type="button" class="btn btn-sm btn-success list-btn" data-id="${id}">List</button>`);

                attachListEvents(); // reattach events
              }
            }
          });
        });
      }

      // LIST CATEGORY
      function attachListEvents() {
        $(".list-btn").off("click").on("click", function () {
          const id = $(this).data("id");
          const btn = $(this);

          $.ajax({
            url: `/admin/categories/list/${id}`,
            method: "PATCH",
            contentType: "application/json",
            success: function (data) {
              if (data.success) {

                // Update badge
                const badge = $(`.status-badge[data-id="${id}"]`);
                badge.text("Active");
                badge.removeClass("alert-danger").addClass("alert-success");

                // Replace button
                btn.replaceWith(`<button type="button" class="btn btn-sm btn-danger unlist-btn" data-id="${id}">Unlist</button>`);

                attachUnlistEvents(); // reattach events
              }
            }
          });
        });
      }
    });
  </script>


</body>

</html>